<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS-360 | Comando Cognitivo OBS360</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js" onload="onApiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <style>
        :root {
            --obs-lime: #84cc16;
            --obs-blue: #28529a;
            --obs-navy: #16213a;
            --obs-dark: #1f2937;
            --obs-bg: #f9fafb;
            --white: #ffffff;
            --gray-text: #4b5563;
        }

        body {
            background-color: var(--obs-bg);
            color: var(--obs-dark);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0;
            color: var(--obs-dark);
        }

        header .brand-tag {
            background: var(--obs-lime);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        main {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .hero p {
            color: var(--gray-text);
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            width: 100%;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }

        .card h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-text);
        }

        input,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--obs-lime);
            box-shadow: 0 0 0 2px rgba(132, 204, 22, 0.2);
        }

        .btn-ignite {
            background: var(--obs-lime);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-ignite:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(132, 204, 22, 0.4);
        }

        .status-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f3f4f6;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease-out;
        }

        .log-entry.success {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }

        .log-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--obs-lime);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .artifact-link {
            display: block;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--obs-dark);
            color: var(--white);
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .artifact-link:hover {
            background: #374151;
        }

        footer {
            padding: 2rem;
            text-align: center;
            font-size: 0.875rem;
            color: var(--gray-text);
            border-top: 1px solid #e5e7eb;
            margin-top: 3rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>NEXUS-360</h1>
        <div class="brand-tag" style="background: var(--obs-blue)">Su Socio Estrat√©gico</div>
    </header>

    <main>
        <div class="hero">
            <h2>Su Socio en el √âxito Cognitivo</h2>
            <p>Ecosistema de BI Multi-Agente para el E-commerce Moderno.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üì• Ingesta Manual</h3>
                <div class="input-group">
                    <label>Nombre de la Fuente</label>
                    <input type="text" id="sourceName" placeholder="ej. An√°lisis_Competencia_Q4.pdf"
                        value="Q4_Financial_Ingestion.pdf">
                </div>
                <div class="input-group">
                    <label>Contenido Crudo / Transcripci√≥n Vision OCR</label>
                    <textarea id="contentText" rows="4"
                        placeholder="Pegue la informaci√≥n recolectada por NEXUS-1...">Ingresos brutos aumentaron 22%. Los costos de adquisici√≥n bajaron un 4%.</textarea>
                </div>
                <div style="margin-top: 20px;">
                    <!-- Controls moved to Drive Card -->
                </div>

                <button class="btn-ignite" onclick="runPipeline()">Iniciar An√°lisis Manual</button>
            </div>

            <div class="card">
                <h3>üìÇ Ingesta Google Drive (Carpeta)</h3>
                <p style="font-size: 0.8rem; color: var(--gray-text); margin-bottom: 1rem;">
                    NEXUS-1 escanear√° la carpeta y procesar√° <strong>todos</strong> los archivos (PDF, CSV, etc.) de
                    forma masiva.
                </p>
                <div class="input-group">
                    <label>Folder ID de Google Drive</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="folderId" placeholder="Ingresa el ID de la carpeta de Google Drive..."
                            value="">
                        <button class="btn-ignite"
                            style="background: #4285f4; width: auto; font-size: 0.8rem; padding: 0.5rem 1rem;"
                            onclick="loadPicker()">Navegar Drive</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Descripci√≥n Detallada del Producto (Par√°metro Rector)</label>
                    <textarea id="productDescription" rows="2"
                        placeholder="ej. L√°mpara de escritorio con carga Qi y control de voz, enfocada en salud visual..."></textarea>
                </div>

                <div style="margin-top: 20px; display:flex; align-items:center; gap:10px; margin-bottom: 15px;">
                    <label class="switch" style="position:relative; display:inline-block; width:40px; height:24px;">
                        <input type="checkbox" id="humanControlToggle" onchange="toggleHumanControl()">
                        <span class="slider"
                            style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px;"></span>
                        <span class="slider-monitor"
                            style="position:absolute; content:''; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%;"></span>
                    </label>
                    <span style="font-size:0.9rem; font-weight:600;">Modo Control Humano (Paso a Paso)</span>
                    <span id="control-badge"
                        style="display:none; background:#2563eb; color:white; font-size:0.7rem; padding:2px 6px; border-radius:4px;">ACTIVADO</span>
                </div>

                <style>
                    input:checked+.slider {
                        background-color: #2563eb;
                    }

                    input:checked+.slider .slider-monitor {
                        transform: translateX(16px);
                    }
                </style>

                <button class="btn-ignite" style="background: var(--obs-dark)" onclick="runFolderPipeline()">Escanear
                    Carpeta Drive</button>
            </div>
        </div>

        <!-- Google Picker Configuration (Activo) -->
        <div id="pickerNotice" style="margin-top: 1rem; font-size: 0.75rem; color: #10b981; display: none;">
            ‚úÖ Motor de Ingesta Google Drive Activo.
        </div>

        <div class="card" id="statusCard" style="display:none; width: 100%; margin-top: 2rem;">
            <h3>‚öôÔ∏è Procesamiento de Agentes</h3>
            <div class="status-panel" id="status-panel">
                <!-- Logs will appear here -->
            </div>
            <div id="result-container"></div>
        </div>

        <!-- SAVED REPORTS FROM FIREBASE -->
        <div class="card" style="width: 100%; margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">üìä Reportes Guardados</h3>
                <button onclick="loadSavedReports()"
                    style="background: var(--obs-blue); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">
                    üîÑ Actualizar
                </button>
            </div>
            <div id="reports-source" style="font-size: 0.7rem; color: #64748b; margin-bottom: 1rem;"></div>
            <div id="saved-reports-list" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                    Cargando reportes...
                </div>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2024 OBS360. NEXUS-360 E-commerce Intelligence Suite.
    </footer>

    <script>
        /* GOOGLE PICKER CONFIGURATION */
        // IMPORTANTE: El usuario debe configurar estas llaves en Google Cloud Console
        const CLIENT_ID = '315205998718-8danf9fjd6r0kmf8b1qeeua32a7pglu8.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDTUm_93wjWwokx9H-mJgMCVSqB91c32Ac'; // Note: Restored for local functionality. Restrict this key in Google Console.
        const SCOPES = 'https://www.googleapis.com/auth/drive';

        let accessToken = null;
        let pickerApiLoaded = false;
        let gisLoaded = false;

        function onApiLoad() {
            gapi.load('picker', () => { pickerApiLoaded = true; });
        }

        function onGisLoad() {
            gisLoaded = true;
        }

        let tokenClient;
        function ensureAuth() {
            return new Promise((resolve, reject) => {
                if (accessToken) {
                    resolve(accessToken);
                    return;
                }

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error !== undefined) {
                            reject(response);
                        }
                        accessToken = response.access_token;
                        resolve(accessToken);
                    },
                });

                tokenClient.requestAccessToken({ prompt: 'consent' });
            });
        }

        async function loadPicker() {
            if (CLIENT_ID === 'TU_CLIENT_ID_AQUI') {
                document.getElementById('pickerNotice').style.display = 'block';
                // Para prop√≥sitos de la demo, permitimos que el usuario vea c√≥mo funcionar√≠a
                console.warn("Google Picker: CLIENT_ID no configurado.");
            }

            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (response) => {
                    if (response.error !== undefined) {
                        throw (response);
                    }
                    accessToken = response.access_token;
                    createPicker();
                },
            });

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function createPicker() {
            if (pickerApiLoaded && accessToken) {
                const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
                    .setSelectableMimeTypes('application/vnd.google-apps.folder')
                    .setIncludeFolders(true)
                    .setMode(google.picker.DocsViewMode.GRID);

                const picker = new google.picker.PickerBuilder()
                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                    .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                    .setDeveloperKey(API_KEY)
                    .setAppId(CLIENT_ID)
                    .setOAuthToken(accessToken)
                    .addView(view)
                    .setCallback(pickerCallback)
                    .build();
                picker.setVisible(true);
            }
        }

        function pickerCallback(data) {
            if (data.action == google.picker.Action.PICKED) {
                const doc = data.docs[0];
                document.getElementById('folderId').value = doc.id;
                console.log("Carpeta seleccionada:", doc.name, doc.id);
            }
        }

        // Human Control Mode State
        let humanControlMode = false;
        let orchestrationState = {};

        function toggleHumanControl() {
            humanControlMode = document.getElementById('humanControlToggle').checked;
            const badge = document.getElementById('control-badge');
            badge.style.display = humanControlMode ? 'inline-block' : 'none';
        }

        async function runFolderPipeline() {
            const folderId = document.getElementById('folderId').value;
            const productDesc = document.getElementById('productDescription').value;
            const panel = document.getElementById('status-panel');
            const statusCard = document.getElementById('statusCard');
            const resultContainer = document.getElementById('result-container');

            if (!folderId) {
                alert("Por favor ingrese un ID de carpeta.");
                return;
            }

            orchestrationState = { product_description: productDesc }; // Clear previous state and store current desc

            try {
                if (!accessToken) {
                    await ensureAuth();
                }
            } catch (e) {
                alert("Autenticaci√≥n fallida. No se puede acceder a Drive.");
                return;
            }

            statusCard.style.display = 'block';
            panel.innerHTML = "";
            resultContainer.innerHTML = '';

            // Initial msg
            panel.innerHTML = `<div class="log-entry"><div class="log-icon">!</div><div>Iniciando Protocolo NEXUS...</div></div>`;

            if (humanControlMode) {
                await runStepByStep(folderId, panel);
            } else {
                await runAutoPipeline(folderId, panel, resultContainer);
            }
        }

        async function runStepByStep(folderId, panel) {
            // STEP 1: HARVESTER
            log(panel, "Ejecutando NEXUS-1 (Harvester)...", "loading");
            const hRes = await callStep('/workflow/step/1_harvester', { folder_id: folderId, access_token: accessToken });

            console.log("Harvester Step Response:", hRes);

            // Safety check for legacy vs new structure
            const docs = hRes.data && hRes.data.ids ? hRes.data.ids : [];
            const filenames = hRes.data && hRes.data.filenames ? hRes.data.filenames : []; // Capture Names
            const data_stats = hRes.data && hRes.data.data_stats ? hRes.data.data_stats : {}; // Capture Stats
            const mode = hRes.data && hRes.data.mode ? hRes.data.mode : 'UNKNOWN';
            const msg = hRes.data && hRes.data.message ? hRes.data.message : 'Error desconocido';

            if (mode === 'ERROR') {
                log(panel, `Error Cr√≠tico: ${msg}`, "error");
                return;
            }

            if (docs.length === 0) {
                log(panel, "Error: No se encontraron archivos en la carpeta. Verifique el ID.", "error");
                return;
            }
            orchestrationState.valid_ids = docs;
            orchestrationState.filenames = filenames; // Store for later steps
            orchestrationState.data_stats = data_stats; // Store stats

            let modeBadge = mode === 'REAL_DRIVE'
                ? '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold; border:1px solid #86efac;">REAL DATA</span>'
                : '<span style="background:#fef9c3; color:#854d0e; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold; border:1px solid #fde047;">DEMO MOCK</span>';

            log(panel, `Harvester Finalizado. ${docs.length} archivos. ${modeBadge}`, "success");

            // SHOW FILENAMES PROOF
            if (filenames.length > 0) {
                let fileListHtml = '<ul style="margin:5px 0 5px 20px; font-size:0.8rem; color:#4b5563;">';
                filenames.forEach(f => {
                    fileListHtml += `<li>üìÑ ${f}</li>`;
                });
                fileListHtml += '</ul>';
                panel.innerHTML += fileListHtml;
            } else if (mode === 'DEMO_MOCK') {
                panel.innerHTML += '<div style="margin:5px 0 5px 20px; font-size:0.8rem; color:#d97706;">‚ö†Ô∏è Usando datos simulados (BaristaAI) porque no se pudo leer la carpeta real.</div>';
            }

            await requireUserApproval(panel, "Proceder a VALIDACI√ìN FORENSE (Agente Guardian)", "NEXUS-8 escanear√° la integridad de los datos para asegurar que no existan inconsistencias o riesgos en la informaci√≥n ingerida.");

            // STEP 2: GUARDIAN
            log(panel, "Ejecutando NEXUS-8 (Guardian)...", "loading");
            const gRes = await callStep('/workflow/step/2_guardian', { data: { ids: orchestrationState.valid_ids } });
            log(panel, `Guardian: ${gRes.data.length} documentos validados.`, "success");

            await requireUserApproval(panel, "Proceder a INTELIGENCIA DE MERCADO (Agente Scout)", "NEXUS-2 cruzar√° los datos con Reddit, TikTok y Amazon para construir el benchmarking de los 10 competidores l√≠deres.");

            // STEP 3: SCOUT
            log(panel, "Ejecutando NEXUS-2 (Scout) - An√°lisis de Mercado...", "loading");
            const sRes = await callStep('/workflow/step/3_scout', {
                filenames: orchestrationState.filenames,
                data_stats: orchestrationState.data_stats,
                product_description: orchestrationState.product_description
            });
            orchestrationState.scout_data = sRes.data;
            log(panel, `Scout: Inteligencia de Mercado obtenida.`, "success");

            // SHOW SCOUT HIGHLIGHTS
            if (sRes.data.top_10_products) {
                let scoutHtml = '<div style="margin:5px 0 10px 20px; font-size:0.85rem; background:#f0f9ff; border:1px solid #bae6fd; padding:10px; border-radius:6px;">';
                scoutHtml += `<strong>Competici√≥n Detectada:</strong> ${sRes.data.top_10_products.length} jugadores clave.<br>`;
                scoutHtml += `<strong>Tendencia:</strong> ${sRes.data.trends[0]}<br>`;
                scoutHtml += '</div>';
                panel.innerHTML += scoutHtml;
            }

            await requireUserApproval(panel, "Proceder a CONSOLIDACI√ìN DE DATOS (Agente Integrator)", "NEXUS-3 fusionar√° la inteligencia de mercado con tus archivos para crear la Fuente √önica de Verdad (SSOT).");

            // STEP 4: INTEGRATOR
            log(panel, "Ejecutando NEXUS-3 (Integrator)...", "loading");
            const iRes = await callStep('/workflow/step/4_integrator', {
                harvester_ids: orchestrationState.valid_ids,
                filenames: orchestrationState.filenames,
                data_stats: orchestrationState.data_stats,
                scout_id: sRes.data.id
            });
            orchestrationState.ssot = iRes.data;
            log(panel, `Integrator: SSOT construida.`, "success");

            await requireUserApproval(panel, "Proceder a DIAGN√ìSTICO ESTRAT√âGICO (Agente Strategist)", "NEXUS-4 detectar√° brechas en el mercado y definir√° el Plan Maestro 2026 para tu producto.");

            // STEP 5: STRATEGIST
            log(panel, "Ejecutando NEXUS-4 (Strategist)...", "loading");
            const stRes = await callStep('/workflow/step/5_strategist', { ssot_data: orchestrationState.ssot });
            orchestrationState.strategy = stRes.data;
            log(panel, `Strategist: ${stRes.data.strategic_gaps.length} gaps detectados.`, "success");

            await requireUserApproval(panel, "Proceder a MODELADO FINANCIERO (Agente Mathematician)", "NEXUS-5 calcular√° los 3 escenarios de rentabilidad (ROI) bas√°ndose en los costos y precios t√°cticos.");

            // STEP 6: MATHEMATICIAN
            log(panel, "Ejecutando NEXUS-5 (Mathematician)...", "loading");
            const mRes = await callStep('/workflow/step/6_mathematician', { strategy_data: orchestrationState.strategy });
            orchestrationState.models = mRes.data;
            log(panel, `Mathematician: Modelado ROI completado.`, "success");

            // STEP 7: SENIOR PARTNER
            log(panel, "Ejecutando NEXUS-6 (Senior Partner)...", "loading");
            const pRes = await callStep('/workflow/step/7_senior_partner', { models_data: orchestrationState.models, strategy_data: orchestrationState.strategy });
            orchestrationState.summary = pRes.data;
            log(panel, `Partner: Resumen Ejecutivo listo.`, "success");

            await requireUserApproval(panel, "Proceder a GENERACI√ìN DE DOSSIER (Agente Architect)", "NEXUS-7 dise√±ar√° el reporte final premium listo para presentaci√≥n ejecutiva.");


            // STEP 8: ARCHITECT
            log(panel, "Ejecutando NEXUS-7 (Architect)...", "loading");
            const full_data = {
                "harvester": { "source": "Drive Step-by-Step", "files": orchestrationState.valid_ids.length },
                "scout": orchestrationState.scout_data,
                "integrator": orchestrationState.ssot,
                "strategist": orchestrationState.strategy,
                "mathematician": orchestrationState.models,
                "senior_partner": orchestrationState.summary
            };
            const aRes = await callStep('/workflow/step/8_architect', { full_data: full_data });
            log(panel, `Arquitecto: Reporte generado.`, "success");

            await requireUserApproval(panel, "Generar AUDITOR√çA INTERNA (Agente Inspector)", "NEXUS-9 generar√° el Blueprint T√©cnico revelando la trazabilidad completa, f√≥rmulas y fuentes para uso confidencial del equipo.");

            // STEP 9: INSPECTOR
            log(panel, "Ejecutando NEXUS-9 (Inspector)...", "loading");
            const insRes = await callStep('/workflow/step/9_inspector', { full_data: full_data });
            log(panel, `Inspector: Blueprint T√©cnico generado.`, "success");

            // Store full_data for Executive Brief generation
            window.lastFullData = full_data;
            window.lastReportId = aRes.data.report_id || aRes.data.id;

            document.getElementById('result-container').innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:20px;">
                    <a href="${aRes.data.pdf_url}" target="_blank" class="artifact-link" style="margin-top:0; background:var(--obs-lime); color:#14532d;">VER REPORTE CLIENTE</a>
                    <a href="${insRes.data.blueprint_url}" target="_blank" class="artifact-link" style="margin-top:0; background:#334155;">VER BLUEPRINT INTERNO (AUDITOR√çA)</a>
                    <button onclick="generateExecutiveBrief()" class="artifact-link" style="margin-top:0; background:#8b5cf6; color:white; border:none; cursor:pointer;">
                        üìä GENERAR EXECUTIVE BRIEF
                    </button>
                </div>`;
        }

        async function generateExecutiveBrief() {
            const panel = document.getElementById('status-panel');
            const resultContainer = document.getElementById('result-container');

            if (!window.lastFullData) {
                alert("No hay datos de an√°lisis disponibles. Ejecute primero el pipeline completo.");
                return;
            }

            // Debug: Log what data we have
            console.log("üìä Executive Brief - Full Data:", window.lastFullData);
            console.log("üìä Scout Keys:", Object.keys(window.lastFullData.scout || {}));

            // Validate we have real scout data - check multiple possible fields
            const scoutData = window.lastFullData.scout || {};
            const scoutKeys = Object.keys(scoutData);
            const hasRealData = scoutData.social_listening || scoutData.top_10_products || scoutData.trends || scoutKeys.length > 3;

            console.log("üìä Scout Keys Found:", scoutKeys);
            console.log("üìä Has Real Data:", hasRealData);

            if (!hasRealData && scoutKeys.length === 0) {
                log(panel, "‚ö†Ô∏è Advertencia: Los datos del Scout est√°n vac√≠os. El brief tendr√° datos gen√©ricos.", "error");
                console.warn("Scout data is completely empty");
            } else if (!scoutData.social_listening) {
                console.log("üìä Scout data present but no social_listening - proceeding anyway");
            }


            log(panel, "Generando Executive Brief (2 p√°ginas, market-first)...", "loading");


            try {
                const response = await callStep('/workflow/step/executive_brief', {
                    full_data: window.lastFullData,
                    full_report_id: window.lastReportId
                });

                if (response.status === 'success') {
                    log(panel, `‚úÖ Executive Brief generado: ${response.data.verdict} (${response.data.confidence}% confianza)`, "success");

                    // Add the new link to results
                    resultContainer.innerHTML += `
                        <div style="margin-top:15px; text-align:center;">
                            <a href="${response.data.brief_path}" target="_blank" 
                               style="display:inline-block; background:linear-gradient(135deg, #8b5cf6, #6366f1); color:white; padding:12px 24px; border-radius:12px; text-decoration:none; font-weight:700; box-shadow:0 4px 15px rgba(139,92,246,0.3);">
                                üìÑ VER EXECUTIVE BRIEF (2 P√ÅGINAS) ‚Üí
                            </a>
                        </div>`;
                } else {
                    log(panel, `Error al generar Executive Brief: ${response.message || 'Error desconocido'}`, "error");
                }
            } catch (e) {
                log(panel, `Error de conexi√≥n: ${e.message}`, "error");
            }
        }

        async function callStep(endpoint, body) {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return await res.json();
        }

        function log(panel, msg, type) {
            let color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
            let icon = type === 'success' ? '‚úì' : (type === 'error' ? 'X' : '>');
            panel.innerHTML += `<div class="log-entry" style="color:${color}"><div class="log-icon">${icon}</div><div>${msg}</div></div>`;
            panel.scrollTop = panel.scrollHeight;
        }

        function requireUserApproval(panel, btnText, description) {
            return new Promise(resolve => {
                const btnId = 'btn-' + Math.random().toString(36).substr(2, 9);
                panel.innerHTML += `
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:15px; border-radius:12px; margin:15px 0; animation:fadeIn 0.5s;">
                        <div style="font-size:0.85rem; color:#64748b; margin-bottom:10px;"><strong>PR√ìXIMO PASO:</strong> ${description || 'El sistema requiere validaci√≥n para continuar.'}</div>
                        <div style="text-align:center;">
                            <button id="${btnId}" style="background:#2563eb; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-family:'Montserrat', sans-serif; transition: all 0.2s;">
                                ${btnText} ‚Üì
                            </button>
                        </div>
                    </div>
                `;
                panel.scrollTop = panel.scrollHeight;
                document.getElementById(btnId).onclick = function () {
                    this.parentElement.parentElement.innerHTML = `<div style="text-align:center; font-size:0.85rem; color:#10b981; margin:10px; font-weight:600;">Autorizado por Socio Humano ‚úì</div>`;
                    resolve();
                };
            });
        }

        async function runAutoPipeline(folderId, panel, resultContainer) {
            // Existing Logic (Legacy Wrapper)
            try {
                const response = await fetch('/workflow/folder_ingestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_id: folderId,
                        access_token: accessToken,
                        product_description: orchestrationState.product_description
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Update steps with links to individual artifacts
                    let modeBadge = data.ingestion_mode === 'REAL_DRIVE'
                        ? '<span style="background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold; border:1px solid #86efac;">REAL DATA</span>'
                        : '<span style="background:#fef9c3; color:#854d0e; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold; border:1px solid #fde047;">DEMO MOCK</span>';

                    const steps = [
                        { name: 'NEXUS-1 (Harvester)', msg: `Procesados ${data.files_processed} archivos. ${modeBadge}`, link: data.artifacts?.harvester },
                        { name: 'NEXUS-8 (Guardian)', msg: 'Validaci√≥n de integridad completada.', link: data.artifacts?.guardian },
                        { name: 'NEXUS-2 (Scout)', msg: 'Enriquecimiento OSINT por lote finalizado.', link: data.artifacts?.scout },
                        { name: 'NEXUS-3 (Integrator)', msg: 'Consolidaci√≥n SSOT.', link: data.artifacts?.integrator },
                        { name: 'NEXUS-4 (Strategist)', msg: 'An√°lisis de brechas estrat√©gicas.', link: data.artifacts?.strategist },
                        { name: 'NEXUS-5 (Mathematician)', msg: 'Modelado financiero de 3 niveles completado.', link: null },
                        { name: 'NEXUS-6 (Senior Partner)', msg: 'S√≠ntesis ejecutiva generada.', link: data.artifacts?.senior_partner },
                        { name: 'NEXUS-7 (Architect)', msg: 'Paquete final generado.', link: data.final_report_url },
                        { name: 'NEXUS-9 (Inspector)', msg: 'Blueprint t√©cnico generado (Uso Interno).', link: data.artifacts?.inspector },
                        { name: 'NEXUS-9 (Archivist)', msg: `Caso archivado. Hash: ${data.product_hash || 'N/A'}`, link: null }
                    ];

                    panel.innerHTML = ""; // Clear initial loading msg

                    steps.forEach((step, index) => {
                        setTimeout(() => {
                            let actionLink = step.link ? `<a href="${step.link}" target="_blank" style="margin-left:auto; font-size:0.75rem; color:#2563eb; text-decoration:none; border:1px solid #bfdbfe; padding:2px 8px; border-radius:12px;">Ver Reporte Agente ‚Üó</a>` : '';

                            panel.innerHTML += `
                                <div class="log-entry success">
                                    <div class="log-icon">‚úì</div>
                                    <div>
                                        <strong>${step.name}</strong><br>
                                        <span style="font-size:0.8rem; color:var(--gray-text)">${step.msg}</span>
                                    </div>
                                    ${actionLink}
                                </div>
                            `;
                            panel.scrollTop = panel.scrollHeight;
                        }, index * 800);
                    });

                    setTimeout(() => {
                        // Store data for Executive Brief generation (auto pipeline)
                        window.lastFullData = data.full_data || {
                            harvester: { source: "Drive Auto", files: data.files_processed },
                            scout: data.artifacts?.scout_data || {},
                            integrator: {},
                            strategist: {},
                            mathematician: {},
                            senior_partner: {},
                            guardian: {}
                        };
                        window.lastReportId = data.report_id || data.final_report_url?.match(/report_([^\.]+)/)?.[1];

                        resultContainer.innerHTML = `
                        <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:20px;">
                            <a href="${data.final_report_url}" target="_blank" class="artifact-link" style="margin-top:0; background:var(--obs-lime); color:#14532d;">VER REPORTE INTEGRADO</a>
                            ${data.artifacts?.inspector ? `<a href="${data.artifacts.inspector}" target="_blank" class="artifact-link" style="margin-top:0; background:#334155;">VER BLUEPRINT INTERNO</a>` : ''}
                            <button onclick="generateExecutiveBrief()" class="artifact-link" style="margin-top:0; background:#8b5cf6; color:white; border:none; cursor:pointer;">
                                üìä GENERAR EXECUTIVE BRIEF
                            </button>
                        </div>`;
                    }, steps.length * 800 + 400);

                } else {
                    panel.innerHTML += `<div class="log-entry" style="background:#fee2e2; border-left:4px solid #ef4444;"><div class="log-icon" style="background:#ef4444">X</div><div><strong>ERROR DE CARPETA</strong><br>${data.detail || data.message}</div></div>`;

                    // Force Re-Auth if it looks like a permission/token issue
                    if (data.mode === 'ERROR' || (data.message && data.message.includes('Autenticaci√≥n'))) {
                        console.warn("Token invalido o permisios insuficientes. Reseteando token.");
                        accessToken = null;
                        document.getElementById('pickerNotice').style.display = 'none'; // Hide notice
                    }
                }
            } catch (e) {
                panel.innerHTML += `<div class="log-entry" style="background:#fee2e2; border-left:4px solid #ef4444;"><div class="log-icon" style="background:#ef4444">X</div><div><strong>FALLA DE CONEXI√ìN</strong><br>${e.message}</div></div>`;
                accessToken = null; // Reset token on network error too just in case
            }
        }

        async function runPipeline() {
            const source = document.getElementById('sourceName').value;
            const content = document.getElementById('contentText').value;
            const panel = document.getElementById('status-panel');
            const statusCard = document.getElementById('statusCard');
            const resultContainer = document.getElementById('result-container');

            statusCard.style.display = 'block';
            panel.innerHTML = `<div class="log-entry"><div class="log-icon">!</div><div>Iniciando orquestaci√≥n... NEXUS-8 (The Guardian) est√° en espera.</div></div>`;
            resultContainer.innerHTML = '';

            try {
                const response = await fetch('/workflow/full_cycle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_name: source, content_text: content })
                });

                const data = await response.json();

                if (response.ok) {
                    const steps = [
                        { name: 'NEXUS-1 (Harvester)', msg: 'Datos ingeridos y guardados en firebase/raw_inputs.' },
                        { name: 'NEXUS-8 (Guardian)', msg: 'Validaci√≥n de integridad completada. Sin amenazas detectadas.' },
                        { name: 'NEXUS-2 (Scout)', msg: 'An√°lisis OSINT y tendencias de b√∫squeda integradas.' },
                        { name: 'NEXUS-3 (Integrator)', msg: 'Single Source of Truth (SSOT) creado con √©xito.' },
                        { name: 'NEXUS-4 (Strategist)', msg: 'Gaps de mercado detectados y oportunidades de marketing identificadas.' },
                        { name: 'NEXUS-5 (Mathematician)', msg: 'Modelado financiero de 3 niveles completado. ROI verificado.' },
                        { name: 'NEXUS-6 (Senior Partner)', msg: 'S√≠ntesis ejecutiva finalizada con tono Calidez Latina.' },
                        { name: 'NEXUS-7 (Architect)', msg: 'Reporte PDF y Dashboard HTML generados.' },
                        { name: 'NEXUS-9 (Archivist)', msg: 'Caso archivado para estudios longitudinales.' }
                    ];

                    steps.forEach((step, index) => {
                        setTimeout(() => {
                            panel.innerHTML += `
                                <div class="log-entry success">
                                    <div class="log-icon">‚úì</div>
                                    <div>
                                        <strong>${step.name}</strong><br>
                                        <span style="font-size:0.8rem; color:var(--gray-text)">${step.msg}</span>
                                    </div>
                                </div>
                            `;
                            panel.scrollTop = panel.scrollHeight;
                        }, index * 800);
                    });

                    setTimeout(() => {
                        resultContainer.innerHTML = `<a href="${data.final_report_url}" target="_blank" class="artifact-link">PRODUCCI√ìN FINALIZADA: VER REPORTE</a>`;
                    }, steps.length * 800 + 400);

                } else {
                    panel.innerHTML += `<div class="log-entry" style="background:#fee2e2; border-left:4px solid #ef4444;"><div class="log-icon" style="background:#ef4444">X</div><div><strong>ERROR DE SISTEMA</strong><br>${data.detail}</div></div>`;
                }
            } catch (e) {
                panel.innerHTML += `<div class="log-entry" style="background:#fee2e2; border-left:4px solid #ef4444;"><div class="log-icon" style="background:#ef4444">X</div><div><strong>FALLA DE CONEXI√ìN</strong><br>${e.message}</div></div>`;
            }
        }

        // --- LOAD SAVED REPORTS FROM FIREBASE ---
        async function loadSavedReports() {
            const container = document.getElementById('saved-reports-list');
            const sourceDiv = document.getElementById('reports-source');

            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">Cargando reportes...</div>';

            try {
                const response = await fetch('/api/reports');
                const data = await response.json();

                const sourceBadge = data.source === 'firebase'
                    ? '<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">üî• Firebase</span>'
                    : '<span style="background:#fef9c3; color:#854d0e; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">üìÅ Local</span>';

                sourceDiv.innerHTML = `Fuente: ${sourceBadge} &nbsp;|&nbsp; ${data.count} reportes encontrados`;

                if (data.reports && data.reports.length > 0) {
                    let html = '';
                    data.reports.forEach((report, idx) => {
                        const dateStr = report.timestamp ? new Date(report.timestamp).toLocaleDateString('es-ES', {
                            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        }) : 'Fecha no disponible';

                        html += `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; border-bottom:1px solid #f1f5f9; transition: background 0.2s;" 
                                 onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                <div style="flex:1;">
                                    <div style="font-weight:600; color:var(--obs-dark); font-size:0.9rem;">${report.title}</div>
                                    <div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">
                                        üìÖ ${dateStr} &nbsp;|&nbsp; ID: ${report.id.substring(0, 8)}...
                                    </div>
                                </div>
                                <a href="${report.report_url}" target="_blank" 
                                   style="background:var(--obs-lime); color:#14532d; padding:6px 12px; border-radius:6px; text-decoration:none; font-size:0.75rem; font-weight:600;">
                                    Ver Reporte ‚Üí
                                </a>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #9ca3af;">No hay reportes guardados a√∫n.</div>';
                }
            } catch (e) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ef4444;">Error cargando reportes: ${e.message}</div>`;
            }
        }

        // Load reports on page load
        document.addEventListener('DOMContentLoaded', loadSavedReports);
    </script>
</body>

</html>